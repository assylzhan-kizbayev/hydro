cmake_minimum_required(VERSION 3.1.0 FATAL_ERROR)

project("hydro")

set(BINARY_NAME "hydro")

set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)  

# Static build flag
set(STATIC_BUILD ${STATIC})   

# Boost libraries
set(Boost_USE_STATIC_RUNTIME ${STATIC_BUILD})
set(Boost_USE_STATIC_LIBS ${STATIC_BUILD})
set(Boost_USE_MULTITHREADED ON)
find_package(Boost COMPONENTS system${BOOST_LIB_SUFFIX}
                              filesystem${BOOST_LIB_SUFFIX}
                              timer${BOOST_LIB_SUFFIX}
                              thread${BOOST_LIB_SUFFIX}
                              chrono${BOOST_LIB_SUFFIX} REQUIRED)
                     
# OpenMP support                              
find_package(OpenMP)
if (OPENMP_FOUND)
    set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} ${OpenMP_C_FLAGS}")
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} ${OpenMP_CXX_FLAGS}")
endif()                              

# GCC warnings
if (UNIX)
  set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra -pedantic")
endif()

# Source folders
aux_source_directory(source/common SOURCES_COMMON)
aux_source_directory(source/control SOURCES_CONTROL)
aux_source_directory(source/hydro2dmpi SOURCES_HYDRO_MODULE)
aux_source_directory(source/test_module SOURCES_TEST_MODULE)
aux_source_directory(source SOURCES_ROOT)

set(SOURCES
  ${SOURCES_COMMON}
  ${SOURCES_CONTROL}
  ${SOURCES_HYDRO_MODULE}
  ${SOURCES_TEST_MODULE}
  ${SOURCES_ROOT}
)

# Add target
add_executable(${BINARY_NAME} ${SOURCES})

# C++11
set_property(TARGET ${BINARY_NAME} PROPERTY CXX_STANDARD 11)
set_property(TARGET ${BINARY_NAME} PROPERTY CXX_STANDARD_REQUIRED ON)

# Static build
if (STATIC_BUILD)
  SET(CMAKE_FIND_LIBRARY_SUFFIXES .a)
  SET(BUILD_SHARED_LIBRARIES OFF)
  SET(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -static")
  set_property(TARGET ${BINARY_NAME} PROPERTY LINK_SEARCH_START_STATIC 1)
  set_property(TARGET ${BINARY_NAME} PROPERTY LINK_SEARCH_END_STATIC 1)
endif()

# Tecplot
if (DEFINED TECPLOT)
  set(TECPLOT_DIR ${TECPLOT})
else()
  set(TECPLOT_DIR "/usr/local/tecplot360ex")
endif()
include_directories(
  ${TECPLOT_DIR}/include
)
find_library(TECIO_LIBRARY tecio ${TECPLOT_DIR}/lib ${TECPLOT_DIR}/bin)

set(LIBRARIES
  pthread
  gomp
  ${Boost_LIBRARIES}
  ${TECIO_LIBRARY}
)

target_link_libraries(${BINARY_NAME} ${LIBRARIES})
